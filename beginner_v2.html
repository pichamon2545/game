<!DOCTYPE html>
<html>
  <head>
    <title>The Timing Game</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-keyboard-response-persist.js"></script>
    <script src="jspsych/plugin-audio-keyboard-response.js"></script>
    <script src="jspsych/plugin-audio-keyboard-response-persist.js"></script>
    <!-- <script src="jspsych/plugin-image-keyboard-response.js"></script> -->
    <script src="jspsych/plugin-preload.js"></script>
    <link rel="stylesheet" href="jspsych/jspsych.css">
  </head>
  <body></body>
  <script type="module">
    import uniform from 'https://cdn.jsdelivr.net/gh/stdlib-js/random-base-uniform@esm/index.mjs';
    function blackscreen() {
        document.body.style.backgroundColor = 'black'
    }
    function whitescreen() {
        document.body.style.backgroundColor = 'white'
    }

    var n = 3

    /* initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function () {
        jsPsych.data.displayData();
      },
    //   override_safe_mode: true
    });

    var preload = {
      type: jsPsychPreload,
      auto_preload: true
    }

    /* create timelines */
    var timeline = [];
    var flow = [];

    /* welcome message */
    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<h1>Welcome to the experiment</h1>
      <p>Press any key to continue.</p>`
    };
    timeline.push(welcome);

    /* begin trials */
    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      on_start: blackscreen,
      stimulus: '',
      choices: "NO_KEYS",
      trial_duration: function(){
        return uniform(400, 1500);
      }
    };
    flow.push(fixation);

    var cue = {
      type: jsPsychAudioKeyboardResponsePersist,
      stimulus: 'tones/3300.mp3',
      prompt: '<div style="height: 200px;width: 200px;background-color: #DC143C;border-radius: 50%;display: inline-block;"></div>',
      trial_duration: 100
    };
    flow.push(cue);

    var reaction_window = {
      type: jsPsychHtmlKeyboardResponsePersist,  
      stimulus: '',
      trial_duration: 400,
    }
    flow.push(reaction_window);

    var early_window = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '',
      trial_duration: 2833,
      data: {
        task: 'early'
      },
      on_finish: function(data) {
        data.early = (data.rt != null);
        if (data.early) {
            jsPsych.addNodeToEndOfTimeline(error_tone)
        }
      }
    }  

    var error_tone = {
      type: jsPsychAudioKeyboardResponsePersist,
      stimulus: 'tones/440.mp3',
      on_start: whitescreen,
      trial_duration: 200
    }

    var early = {
      type: jsPsychHtmlKeyboardResponsePersist,  
      stimulus: '',
      trial_duration: 6300 - jsPsych.data.get().filter({ task: 'early' }).select('rt').values.slice(-1)
    }

    var reward_window = {
      type: jsPsychHtmlKeyboardResponse,  
      stimulus: '',
      trial_duration: 1667,
      data: {
        task: 'reward'
      },
      on_finish: function (data) {
        data.pressed = (data.rt != null);
      }
    }

    var if_press = {
      type: jsPsychAudioKeyboardResponsePersist,
      stimulus: 'tones/5050.mp3',
      prompt: '<div style="font-size:200px;">ðŸ’°</div>',
      trial_duration: 200
    }

    var rewarded = {
      type: jsPsychHtmlKeyboardResponsePersist,  
      stimulus: '',
      trial_duration: 3467 - jsPsych.data.get().filter({ task: 'reward' }).select('rt').values.slice(-1)
    }

    var reward_tone = {
      type: jsPsychAudioKeyboardResponsePersist,
      stimulus: 'tones/5050.mp3',
      trial_duration: 200
    }

    var waited = {
      type: jsPsychHtmlKeyboardResponse,  
      stimulus: '',
      data: {
        task: 'press'
      },
      trial_duration: 1800,
      on_finish: function(data) {
        data.pressed = (data.rt != null);
      }
    }

    var show_nickel = {
      type: jsPsychHtmlKeyboardResponsePersist,  
      stimulus: '<div style="font-size:200px;">ðŸ’°</div>',
      stimulus_duration: 200,
      trial_duration: 2000 - jsPsych.data.get().filter({ task: 'press' }).select('rt').values.slice(-1)
    }

    var ITI = {
      type: jsPsychHtmlKeyboardResponsePersist,  
      stimulus: '',
      trial_duration: 10000
    }

    var if_wait = {
      type: jsPsychHtmlKeyboardResponse,  
      on_start: whitescreen,
      stimulus: '',
      data: {
        task: 'press_ITI'
      },
      trial_duration: 10000,
      on_finish: function(data) {
        data.pressed = (data.rt != null);
      }
    }

    var show_nickel_white = {
      type: jsPsychHtmlKeyboardResponsePersist,  
      stimulus: '<div style="font-size:200px;">ðŸ’°</div>',
      stimulus_duration: 200,
      trial_duration: 10000 - jsPsych.data.get().filter({ task: 'press_ITI' }).select('rt').values.slice(-1)
    }

    /* define test procedure */
    var test_procedure = {
      timeline: [],
      repetitions: n
    }
    timeline.push(test_procedure);


    /* start the experiment */
    jsPsych.run(timeline);
  
  </script>
</html>